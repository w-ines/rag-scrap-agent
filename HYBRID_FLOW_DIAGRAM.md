# ğŸ”„ Hybrid RAG Solution - Visual Flow Diagram

## Complete Request Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          USER ACTION                                 â”‚
â”‚  Uploads: agent.pdf                                                  â”‚
â”‚  Query: "summarize this document"                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FRONTEND (Next.js)                                â”‚
â”‚  - Creates FormData(query + files)                                   â”‚
â”‚  - POST /api/ask                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              NEXT.JS API ROUTE (/api/ask/route.ts)                  â”‚
â”‚  - Detects multipart/form-data                                       â”‚
â”‚  - Forwards to backend FastAPI                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  BACKEND FASTAPI (main.py)                           â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ STEP 1: FILE UPLOAD & INDEXATION                             â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  For each file:                                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ a) store_pdf(file)                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â†’ Supabase Storage                                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â†’ Returns: file_url                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ b) parse_pdf(file)                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â†’ Extracts text from PDF                            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â†’ Returns: List[Document]                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ c) index_documents(documents)                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â†’ Chunking (1000 chars, 200 overlap)               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â†’ Embeddings via Ollama (mxbai-embed-large)        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â†’ Store in Supabase pgvector                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚    â†’ Returns: 108 chunks stored                        â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  Result: uploaded_context = [                                 â”‚  â”‚
â”‚  â”‚    {                                                          â”‚  â”‚
â”‚  â”‚      "filename": "agent.pdf",                                 â”‚  â”‚
â”‚  â”‚      "doc_id": "a4586965-...",                                â”‚  â”‚
â”‚  â”‚      "chunks": 108                                            â”‚  â”‚
â”‚  â”‚    }                                                          â”‚  â”‚
â”‚  â”‚  ]                                                            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ STEP 2: HYBRID APPROACH ğŸ”„                                   â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  A) PRE-FETCH PREVIEW                                         â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ preview_result = retrieve_knowledge(                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     query="document overview summary",                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     top_k=3  # Small preview                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ )                                                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ What happens:                                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ 1. Query â†’ Embedding [1024 dims]                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ 2. Similarity search in pgvector                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ 3. Returns top 3 chunks with scores                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ Result:                                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ {                                                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   "context": "This document discusses AI agents..."    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   "results": [chunk1, chunk2, chunk3],                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   "sources": [...]                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ }                                                       â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  B) BUILD ENHANCED CONTEXT MESSAGE                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ context_msg = """                                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ [Context: User uploaded 1 file: agent.pdf]            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ [Total chunks indexed: 108]                            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ IMPORTANT INSTRUCTIONS FOR YOU (the agent):            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ 1. Files ALREADY indexed in Supabase vector DB        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ 2. MUST use retrieve_knowledge() tool                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ 3. DO NOT use pdf_reader, file_reader - don't exist   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ Example usage:                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ <code>                                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ result = retrieve_knowledge(                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     query="document summary",                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     top_k=20                                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ )                                                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ print(result['context'][:500])                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ </code>                                                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ Document preview (first 400 chars):                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ ---                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ This document discusses AI agents and their            â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ architecture, including tool usage, reasoning...       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ ---                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ Use retrieve_knowledge() to get full content.          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ """                                                     â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  C) CALL AGENT WITH ENHANCED QUERY                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ agent_query = query + context_msg                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ Full query sent to agent:                              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ "summarize this document                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  [Context: User uploaded 1 file: agent.pdf]           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  [Total chunks indexed: 108]                           â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  IMPORTANT INSTRUCTIONS...                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  Document preview: ...                                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  Use retrieve_knowledge()..."                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚                                                         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ result = run_agent_sync(agent_query)                   â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SMOLAGENT (agent.py)                              â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ AGENT INITIALIZATION                                          â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚ CodeAgent(                                                    â”‚  â”‚
â”‚  â”‚   tools=[                                                     â”‚  â”‚
â”‚  â”‚     get_weather_simple,                                       â”‚  â”‚
â”‚  â”‚     web_search,                                               â”‚  â”‚
â”‚  â”‚     webscraper,                                               â”‚  â”‚
â”‚  â”‚     retrieve_knowledge  â† The tool we want to use            â”‚  â”‚
â”‚  â”‚   ],                                                          â”‚  â”‚
â”‚  â”‚   model=llama3:8b,                                            â”‚  â”‚
â”‚  â”‚   additional_system_prompt="""                                â”‚  â”‚
â”‚  â”‚     CRITICAL RULES FOR DOCUMENT HANDLING:                     â”‚  â”‚
â”‚  â”‚     1. âœ… Files ALREADY indexed                              â”‚  â”‚
â”‚  â”‚     2. âœ… MUST use retrieve_knowledge()                      â”‚  â”‚
â”‚  â”‚     3. âŒ DO NOT use pdf_reader, file_reader                 â”‚  â”‚
â”‚  â”‚     ...                                                       â”‚  â”‚
â”‚  â”‚   """                                                         â”‚  â”‚
â”‚  â”‚ )                                                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ AGENT REASONING - STEP 1                                      â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚ Thought:                                                      â”‚  â”‚
â”‚  â”‚ "I see the user uploaded agent.pdf and wants a summary.      â”‚  â”‚
â”‚  â”‚  The context shows 108 chunks are indexed in the vector DB.  â”‚  â”‚
â”‚  â”‚  I can see a preview of the content.                         â”‚  â”‚
â”‚  â”‚  The instructions tell me to use retrieve_knowledge().       â”‚  â”‚
â”‚  â”‚  I will follow the example provided."                        â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚ Code:                                                         â”‚  â”‚
â”‚  â”‚ <code>                                                        â”‚  â”‚
â”‚  â”‚ result = retrieve_knowledge(                                  â”‚  â”‚
â”‚  â”‚     query="document summary",                                 â”‚  â”‚
â”‚  â”‚     top_k=20  # Get comprehensive content                    â”‚  â”‚
â”‚  â”‚ )                                                             â”‚  â”‚
â”‚  â”‚ print(f"Retrieved {len(result['results'])} chunks")          â”‚  â”‚
â”‚  â”‚ print(result['context'][:1000])                               â”‚  â”‚
â”‚  â”‚ </code>                                                       â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚ Observation:                                                  â”‚  â”‚
â”‚  â”‚ "Retrieved 20 chunks                                          â”‚  â”‚
â”‚  â”‚  Source [1] | score=0.89: agent.pdf                          â”‚  â”‚
â”‚  â”‚  This document discusses AI agents and their architecture... â”‚  â”‚
â”‚  â”‚  Source [2] | score=0.85: agent.pdf                          â”‚  â”‚
â”‚  â”‚  The agent uses tools like web_search, webscraper...         â”‚  â”‚
â”‚  â”‚  ..."                                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ AGENT REASONING - STEP 2                                      â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚ Thought:                                                      â”‚  â”‚
â”‚  â”‚ "I now have the full document content from 20 chunks.        â”‚  â”‚
â”‚  â”‚  I can see the main topics and structure.                    â”‚  â”‚
â”‚  â”‚  I'll synthesize a comprehensive summary with citations."    â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚ Code:                                                         â”‚  â”‚
â”‚  â”‚ <code>                                                        â”‚  â”‚
â”‚  â”‚ summary = """                                                 â”‚  â”‚
â”‚  â”‚ Based on the document 'agent.pdf' [1][2][3], here's a        â”‚  â”‚
â”‚  â”‚ comprehensive summary:                                        â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚ **Overview:**                                                 â”‚  â”‚
â”‚  â”‚ This document discusses AI agent architecture and             â”‚  â”‚
â”‚  â”‚ implementation [1]. The agent is designed to solve tasks      â”‚  â”‚
â”‚  â”‚ using code execution and tool calling [2].                    â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚ **Key Components:**                                           â”‚  â”‚
â”‚  â”‚ 1. Tool System [3][4]:                                        â”‚  â”‚
â”‚  â”‚    - web_search: For finding information online              â”‚  â”‚
â”‚  â”‚    - webscraper: For extracting webpage content              â”‚  â”‚
â”‚  â”‚    - retrieve_knowledge: For RAG operations                   â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚ 2. Reasoning Process [5][6]:                                  â”‚  â”‚
â”‚  â”‚    - Thought: Plans the approach                             â”‚  â”‚
â”‚  â”‚    - Code: Executes tools                                    â”‚  â”‚
â”‚  â”‚    - Observation: Reviews results                            â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚ 3. Multi-step Planning [7]:                                   â”‚  â”‚
â”‚  â”‚    - Can chain multiple tool calls                           â”‚  â”‚
â”‚  â”‚    - Adapts based on observations                            â”‚  â”‚
â”‚  â”‚    - Provides final answer with citations                    â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚ **Conclusion:**                                               â”‚  â”‚
â”‚  â”‚ The document provides a comprehensive guide to building       â”‚  â”‚
â”‚  â”‚ intelligent agents capable of autonomous task solving [8].    â”‚  â”‚
â”‚  â”‚ """                                                           â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚ final_answer(summary)                                         â”‚  â”‚
â”‚  â”‚ </code>                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                       â”‚
â”‚  Final Answer: [Comprehensive summary with citations]                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RESPONSE TO USER                                  â”‚
â”‚                                                                       â”‚
â”‚  {                                                                    â”‚
â”‚    "answer": "Based on the document 'agent.pdf' [1][2][3]..."       â”‚
â”‚  }                                                                    â”‚
â”‚                                                                       â”‚
â”‚  âœ… Success!                                                         â”‚
â”‚  âœ… Accurate summary                                                 â”‚
â”‚  âœ… Proper citations                                                 â”‚
â”‚  âœ… Used correct tool (retrieve_knowledge)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Key Decision Points

### ğŸ” Decision Point 1: Pre-fetch or Not?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ uploaded_context exists?            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â”‚             â”‚
   YES           NO
    â”‚             â”‚
    â†“             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Pre-fetch â”‚  â”‚ Skip to      â”‚
â”‚ preview   â”‚  â”‚ agent call   â”‚
â”‚ (3 chunks)â”‚  â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ¯ Decision Point 2: Agent Tool Selection

```
Agent receives enhanced query with:
- Document preview âœ…
- Explicit instructions âœ…
- Working example âœ…

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Agent analyzes context              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                          â”‚
    â†“                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Sees preview â”‚      â”‚ Sees instructionsâ”‚
â”‚ "Content     â”‚      â”‚ "MUST use        â”‚
â”‚  exists!"    â”‚      â”‚  retrieve_       â”‚
â”‚              â”‚      â”‚  knowledge()"    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                       â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Agent decides:        â”‚
        â”‚ Use retrieve_         â”‚
        â”‚ knowledge()           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Comparison: Before vs After

### âŒ Before (Failed Flow)

```
User â†’ Backend â†’ Agent
                  â”‚
                  â†“
            "I need to read PDF"
                  â”‚
                  â†“
            pdf_reader()  â† Doesn't exist!
                  â”‚
                  â†“
              ERROR
                  â”‚
                  â†“
            file_reader() â† Doesn't exist!
                  â”‚
                  â†“
              ERROR
                  â”‚
                  â†“
         "I give up, guess based on filename"
                  â”‚
                  â†“
         Generic useless answer âŒ
```

### âœ… After (Success Flow)

```
User â†’ Backend â†’ Pre-fetch preview â†’ Enhanced context â†’ Agent
                                                          â”‚
                                                          â†“
                                            "I see content exists"
                                            "Instructions say use"
                                            "retrieve_knowledge()"
                                                          â”‚
                                                          â†“
                                            retrieve_knowledge()
                                                          â”‚
                                                          â†“
                                            Retrieved 20 chunks
                                                          â”‚
                                                          â†“
                                            Synthesize summary
                                                          â”‚
                                                          â†“
                                            Accurate answer âœ…
```

---

## Timeline Comparison

### Before (Failed - 149 seconds)
```
0s    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> 149s
â”‚                                                              â”‚
Upload & Index (10s)                                    Give up
â”‚                                                              â”‚
â””â”€> Try pdf_reader (115s) â”€> Try file_reader (15s) â”€> Guess (19s)
    âŒ Error                 âŒ Error                  âŒ Wrong
```

### After (Success - ~30 seconds estimated)
```
0s    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> 30s
â”‚                                          â”‚
Upload & Index (10s)                    Success!
â”‚                                          â”‚
â””â”€> Pre-fetch (2s) â”€> Agent Step 1 (10s) â”€> Agent Step 2 (8s)
    âœ… Preview        âœ… Retrieve          âœ… Synthesize
```

---

## Data Flow

### Document Indexing
```
PDF File (agent.pdf)
    â†“
parse_pdf()
    â†“
["Page 1 text...", "Page 2 text...", ...]
    â†“
chunk_documents(chunk_size=1000, overlap=200)
    â†“
[
  "Chunk 1: This document discusses...",
  "Chunk 2: AI agents use tools...",
  "Chunk 3: The reasoning process...",
  ...
  "Chunk 108: Conclusion..."
]
    â†“
get_embedding() for each chunk
    â†“
[
  [0.234, -0.567, 0.891, ..., 0.123],  â† 1024 dimensions
  [0.456, -0.234, 0.678, ..., 0.345],
  ...
]
    â†“
Store in Supabase pgvector
    â†“
documents table:
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id â”‚ content          â”‚ metadata         â”‚ embedding    â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1  â”‚ "Chunk 1: ..."   â”‚ {filename: ...}  â”‚ [0.234, ...] â”‚
â”‚ 2  â”‚ "Chunk 2: ..."   â”‚ {filename: ...}  â”‚ [0.456, ...] â”‚
â”‚... â”‚ ...              â”‚ ...              â”‚ ...          â”‚
â”‚108 â”‚ "Chunk 108: ..." â”‚ {filename: ...}  â”‚ [0.789, ...] â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Retrieval Process
```
Query: "document summary"
    â†“
get_embedding(query)
    â†“
[0.345, -0.678, 0.234, ..., 0.567]  â† Query vector
    â†“
Similarity search (cosine distance)
    â†“
SELECT * FROM documents
ORDER BY embedding <=> query_embedding
LIMIT 20
    â†“
[
  {content: "Chunk 1...", score: 0.89},
  {content: "Chunk 5...", score: 0.85},
  {content: "Chunk 3...", score: 0.82},
  ...
]
    â†“
Format as context
    â†“
"""
Source [1] | score=0.89: agent.pdf
Chunk 1: This document discusses...

Source [2] | score=0.85: agent.pdf
Chunk 5: AI agents use tools...
...
"""
```

---

This visual diagram shows the complete flow of the hybrid solution, making it easy to understand how each component works together.
